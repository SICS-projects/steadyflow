/* FileListController.c generated by valac 0.16.1, the Vala compiler
 * generated from FileListController.vala, do not modify */

/*
    FileListController.vala
    Copyright (C) 2010 Maia Kozheva <sikon@ubuntu.com>

    This program is free software: you can redistribute it and/or modify
    it under the terms of the GNU General Public License as published by
    the Free Software Foundation, either version 3 of the License, or
    (at your option) any later version.

    This program is distributed in the hope that it will be useful,
    but WITHOUT ANY WARRANTY; without even the implied warranty of
    MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
    GNU General Public License for more details.

    You should have received a copy of the GNU General Public License
    along with this program.  If not, see <http://www.gnu.org/licenses/>.
*/

#include <glib.h>
#include <glib-object.h>
#include <gtk/gtk.h>
#include <stdlib.h>
#include <string.h>
#include <float.h>
#include <math.h>
#include <gee.h>
#include <gio/gio.h>
#include <glib/gi18n-lib.h>


#define STEADYFLOW_TYPE_FILE_LIST_CONTROLLER (steadyflow_file_list_controller_get_type ())
#define STEADYFLOW_FILE_LIST_CONTROLLER(obj) (G_TYPE_CHECK_INSTANCE_CAST ((obj), STEADYFLOW_TYPE_FILE_LIST_CONTROLLER, SteadyflowFileListController))
#define STEADYFLOW_FILE_LIST_CONTROLLER_CLASS(klass) (G_TYPE_CHECK_CLASS_CAST ((klass), STEADYFLOW_TYPE_FILE_LIST_CONTROLLER, SteadyflowFileListControllerClass))
#define STEADYFLOW_IS_FILE_LIST_CONTROLLER(obj) (G_TYPE_CHECK_INSTANCE_TYPE ((obj), STEADYFLOW_TYPE_FILE_LIST_CONTROLLER))
#define STEADYFLOW_IS_FILE_LIST_CONTROLLER_CLASS(klass) (G_TYPE_CHECK_CLASS_TYPE ((klass), STEADYFLOW_TYPE_FILE_LIST_CONTROLLER))
#define STEADYFLOW_FILE_LIST_CONTROLLER_GET_CLASS(obj) (G_TYPE_INSTANCE_GET_CLASS ((obj), STEADYFLOW_TYPE_FILE_LIST_CONTROLLER, SteadyflowFileListControllerClass))

typedef struct _SteadyflowFileListController SteadyflowFileListController;
typedef struct _SteadyflowFileListControllerClass SteadyflowFileListControllerClass;
typedef struct _SteadyflowFileListControllerPrivate SteadyflowFileListControllerPrivate;
#define _g_object_unref0(var) ((var == NULL) ? NULL : (var = (g_object_unref (var), NULL)))
#define _g_free0(var) (var = (g_free (var), NULL))
#define _g_timer_destroy0(var) ((var == NULL) ? NULL : (var = (g_timer_destroy (var), NULL)))

#define STEADYFLOW_UI_TYPE_DOWNLOAD_CELL_RENDERER (steadyflow_ui_download_cell_renderer_get_type ())
#define STEADYFLOW_UI_DOWNLOAD_CELL_RENDERER(obj) (G_TYPE_CHECK_INSTANCE_CAST ((obj), STEADYFLOW_UI_TYPE_DOWNLOAD_CELL_RENDERER, SteadyflowUIDownloadCellRenderer))
#define STEADYFLOW_UI_DOWNLOAD_CELL_RENDERER_CLASS(klass) (G_TYPE_CHECK_CLASS_CAST ((klass), STEADYFLOW_UI_TYPE_DOWNLOAD_CELL_RENDERER, SteadyflowUIDownloadCellRendererClass))
#define STEADYFLOW_UI_IS_DOWNLOAD_CELL_RENDERER(obj) (G_TYPE_CHECK_INSTANCE_TYPE ((obj), STEADYFLOW_UI_TYPE_DOWNLOAD_CELL_RENDERER))
#define STEADYFLOW_UI_IS_DOWNLOAD_CELL_RENDERER_CLASS(klass) (G_TYPE_CHECK_CLASS_TYPE ((klass), STEADYFLOW_UI_TYPE_DOWNLOAD_CELL_RENDERER))
#define STEADYFLOW_UI_DOWNLOAD_CELL_RENDERER_GET_CLASS(obj) (G_TYPE_INSTANCE_GET_CLASS ((obj), STEADYFLOW_UI_TYPE_DOWNLOAD_CELL_RENDERER, SteadyflowUIDownloadCellRendererClass))

typedef struct _SteadyflowUIDownloadCellRenderer SteadyflowUIDownloadCellRenderer;
typedef struct _SteadyflowUIDownloadCellRendererClass SteadyflowUIDownloadCellRendererClass;

#define STEADYFLOW_CORE_TYPE_IDOWNLOAD_FILE (steadyflow_core_idownload_file_get_type ())
#define STEADYFLOW_CORE_IDOWNLOAD_FILE(obj) (G_TYPE_CHECK_INSTANCE_CAST ((obj), STEADYFLOW_CORE_TYPE_IDOWNLOAD_FILE, SteadyflowCoreIDownloadFile))
#define STEADYFLOW_CORE_IS_IDOWNLOAD_FILE(obj) (G_TYPE_CHECK_INSTANCE_TYPE ((obj), STEADYFLOW_CORE_TYPE_IDOWNLOAD_FILE))
#define STEADYFLOW_CORE_IDOWNLOAD_FILE_GET_INTERFACE(obj) (G_TYPE_INSTANCE_GET_INTERFACE ((obj), STEADYFLOW_CORE_TYPE_IDOWNLOAD_FILE, SteadyflowCoreIDownloadFileIface))

typedef struct _SteadyflowCoreIDownloadFile SteadyflowCoreIDownloadFile;
typedef struct _SteadyflowCoreIDownloadFileIface SteadyflowCoreIDownloadFileIface;

#define STEADYFLOW_CORE_IDOWNLOAD_FILE_TYPE_STATUS (steadyflow_core_idownload_file_status_get_type ())

#define STEADYFLOW_CORE_IDOWNLOAD_FILE_TYPE_FINISH_ACTION (steadyflow_core_idownload_file_finish_action_get_type ())

#define STEADYFLOW_CORE_TYPE_IDOWNLOAD_SERVICE (steadyflow_core_idownload_service_get_type ())
#define STEADYFLOW_CORE_IDOWNLOAD_SERVICE(obj) (G_TYPE_CHECK_INSTANCE_CAST ((obj), STEADYFLOW_CORE_TYPE_IDOWNLOAD_SERVICE, SteadyflowCoreIDownloadService))
#define STEADYFLOW_CORE_IS_IDOWNLOAD_SERVICE(obj) (G_TYPE_CHECK_INSTANCE_TYPE ((obj), STEADYFLOW_CORE_TYPE_IDOWNLOAD_SERVICE))
#define STEADYFLOW_CORE_IDOWNLOAD_SERVICE_GET_INTERFACE(obj) (G_TYPE_INSTANCE_GET_INTERFACE ((obj), STEADYFLOW_CORE_TYPE_IDOWNLOAD_SERVICE, SteadyflowCoreIDownloadServiceIface))

typedef struct _SteadyflowCoreIDownloadService SteadyflowCoreIDownloadService;
typedef struct _SteadyflowCoreIDownloadServiceIface SteadyflowCoreIDownloadServiceIface;
#define _gtk_tree_path_free0(var) ((var == NULL) ? NULL : (var = (gtk_tree_path_free (var), NULL)))
#define __g_list_free__gtk_tree_path_free0_0(var) ((var == NULL) ? NULL : (var = (_g_list_free__gtk_tree_path_free0_ (var), NULL)))

#define STEADYFLOW_UI_TYPE_GTK_BUILDER_DIALOG (steadyflow_ui_gtk_builder_dialog_get_type ())
#define STEADYFLOW_UI_GTK_BUILDER_DIALOG(obj) (G_TYPE_CHECK_INSTANCE_CAST ((obj), STEADYFLOW_UI_TYPE_GTK_BUILDER_DIALOG, SteadyflowUIGtkBuilderDialog))
#define STEADYFLOW_UI_GTK_BUILDER_DIALOG_CLASS(klass) (G_TYPE_CHECK_CLASS_CAST ((klass), STEADYFLOW_UI_TYPE_GTK_BUILDER_DIALOG, SteadyflowUIGtkBuilderDialogClass))
#define STEADYFLOW_UI_IS_GTK_BUILDER_DIALOG(obj) (G_TYPE_CHECK_INSTANCE_TYPE ((obj), STEADYFLOW_UI_TYPE_GTK_BUILDER_DIALOG))
#define STEADYFLOW_UI_IS_GTK_BUILDER_DIALOG_CLASS(klass) (G_TYPE_CHECK_CLASS_TYPE ((klass), STEADYFLOW_UI_TYPE_GTK_BUILDER_DIALOG))
#define STEADYFLOW_UI_GTK_BUILDER_DIALOG_GET_CLASS(obj) (G_TYPE_INSTANCE_GET_CLASS ((obj), STEADYFLOW_UI_TYPE_GTK_BUILDER_DIALOG, SteadyflowUIGtkBuilderDialogClass))

typedef struct _SteadyflowUIGtkBuilderDialog SteadyflowUIGtkBuilderDialog;
typedef struct _SteadyflowUIGtkBuilderDialogClass SteadyflowUIGtkBuilderDialogClass;

#define STEADYFLOW_TYPE_ADD_FILE_DIALOG (steadyflow_add_file_dialog_get_type ())
#define STEADYFLOW_ADD_FILE_DIALOG(obj) (G_TYPE_CHECK_INSTANCE_CAST ((obj), STEADYFLOW_TYPE_ADD_FILE_DIALOG, SteadyflowAddFileDialog))
#define STEADYFLOW_ADD_FILE_DIALOG_CLASS(klass) (G_TYPE_CHECK_CLASS_CAST ((klass), STEADYFLOW_TYPE_ADD_FILE_DIALOG, SteadyflowAddFileDialogClass))
#define STEADYFLOW_IS_ADD_FILE_DIALOG(obj) (G_TYPE_CHECK_INSTANCE_TYPE ((obj), STEADYFLOW_TYPE_ADD_FILE_DIALOG))
#define STEADYFLOW_IS_ADD_FILE_DIALOG_CLASS(klass) (G_TYPE_CHECK_CLASS_TYPE ((klass), STEADYFLOW_TYPE_ADD_FILE_DIALOG))
#define STEADYFLOW_ADD_FILE_DIALOG_GET_CLASS(obj) (G_TYPE_INSTANCE_GET_CLASS ((obj), STEADYFLOW_TYPE_ADD_FILE_DIALOG, SteadyflowAddFileDialogClass))

typedef struct _SteadyflowAddFileDialog SteadyflowAddFileDialog;
typedef struct _SteadyflowAddFileDialogClass SteadyflowAddFileDialogClass;
#define _g_error_free0(var) ((var == NULL) ? NULL : (var = (g_error_free (var), NULL)))

struct _SteadyflowFileListController {
	GObject parent_instance;
	SteadyflowFileListControllerPrivate * priv;
};

struct _SteadyflowFileListControllerClass {
	GObjectClass parent_class;
};

struct _SteadyflowFileListControllerPrivate {
	GtkTreeView* tree;
	GtkListStore* model;
	gchar* filter;
	GTimer* redraw_timer;
};

typedef enum  {
	STEADYFLOW_CORE_IDOWNLOAD_FILE_STATUS_CONNECTING = 0,
	STEADYFLOW_CORE_IDOWNLOAD_FILE_STATUS_DOWNLOADING,
	STEADYFLOW_CORE_IDOWNLOAD_FILE_STATUS_PAUSED,
	STEADYFLOW_CORE_IDOWNLOAD_FILE_STATUS_FINISHED,
	STEADYFLOW_CORE_IDOWNLOAD_FILE_STATUS_NETWORK_ERROR
} SteadyflowCoreIDownloadFileStatus;

typedef enum  {
	STEADYFLOW_CORE_IDOWNLOAD_FILE_FINISH_ACTION_DO_NOTHING = 0,
	STEADYFLOW_CORE_IDOWNLOAD_FILE_FINISH_ACTION_OPEN_FILE,
	STEADYFLOW_CORE_IDOWNLOAD_FILE_FINISH_ACTION_OPEN_FOLDER,
	STEADYFLOW_CORE_IDOWNLOAD_FILE_FINISH_ACTION_RUN_COMMAND
} SteadyflowCoreIDownloadFileFinishAction;

struct _SteadyflowCoreIDownloadFileIface {
	GTypeInterface parent_iface;
	void (*start) (SteadyflowCoreIDownloadFile* self, gboolean resume);
	void (*pause) (SteadyflowCoreIDownloadFile* self);
	void (*serialize) (SteadyflowCoreIDownloadFile* self, GKeyFile* file);
	SteadyflowCoreIDownloadFileStatus (*get_status) (SteadyflowCoreIDownloadFile* self);
	gint (*get_uid) (SteadyflowCoreIDownloadFile* self);
	const gchar* (*get_url) (SteadyflowCoreIDownloadFile* self);
	const gchar* (*get_local_name) (SteadyflowCoreIDownloadFile* self);
	const gchar* (*get_local_basename) (SteadyflowCoreIDownloadFile* self);
	gint64 (*get_size) (SteadyflowCoreIDownloadFile* self);
	gint64 (*get_downloaded_size) (SteadyflowCoreIDownloadFile* self);
	gint (*get_speed) (SteadyflowCoreIDownloadFile* self);
	const gchar* (*get_icon_name) (SteadyflowCoreIDownloadFile* self);
	SteadyflowCoreIDownloadFileFinishAction (*get_finish_action) (SteadyflowCoreIDownloadFile* self);
	const gchar* (*get_finish_command) (SteadyflowCoreIDownloadFile* self);
	GError* (*get_error) (SteadyflowCoreIDownloadFile* self);
};

struct _SteadyflowCoreIDownloadServiceIface {
	GTypeInterface parent_iface;
	SteadyflowCoreIDownloadFile* (*get_file_by_uid) (SteadyflowCoreIDownloadService* self, gint uid);
	SteadyflowCoreIDownloadFile* (*add_file) (SteadyflowCoreIDownloadService* self, const gchar* url, const gchar* local_name, SteadyflowCoreIDownloadFileFinishAction finish_action, const gchar* finish_command, GError** error);
	void (*remove_file) (SteadyflowCoreIDownloadService* self, SteadyflowCoreIDownloadFile* file);
	GeeList* (*get_files) (SteadyflowCoreIDownloadService* self);
};


static gpointer steadyflow_file_list_controller_parent_class = NULL;

GType steadyflow_file_list_controller_get_type (void) G_GNUC_CONST;
#define STEADYFLOW_FILE_LIST_CONTROLLER_GET_PRIVATE(o) (G_TYPE_INSTANCE_GET_PRIVATE ((o), STEADYFLOW_TYPE_FILE_LIST_CONTROLLER, SteadyflowFileListControllerPrivate))
enum  {
	STEADYFLOW_FILE_LIST_CONTROLLER_DUMMY_PROPERTY
};
#define STEADYFLOW_FILE_LIST_CONTROLLER_REDRAW_SEC 0.2
SteadyflowFileListController* steadyflow_file_list_controller_new (GtkTreeView* tree);
SteadyflowFileListController* steadyflow_file_list_controller_construct (GType object_type, GtkTreeView* tree);
SteadyflowUIDownloadCellRenderer* steadyflow_ui_download_cell_renderer_new (void);
SteadyflowUIDownloadCellRenderer* steadyflow_ui_download_cell_renderer_construct (GType object_type);
GType steadyflow_ui_download_cell_renderer_get_type (void) G_GNUC_CONST;
static void steadyflow_file_list_controller_set_cell_data (SteadyflowFileListController* self, GtkCellLayout* cell_layout, GtkCellRenderer* renderer, GtkTreeModel* model, GtkTreeIter* iter);
static void _steadyflow_file_list_controller_set_cell_data_gtk_cell_layout_data_func (GtkCellLayout* cell_layout, GtkCellRenderer* cell, GtkTreeModel* tree_model, GtkTreeIter* iter, gpointer self);
GType steadyflow_core_idownload_file_status_get_type (void) G_GNUC_CONST;
GType steadyflow_core_idownload_file_finish_action_get_type (void) G_GNUC_CONST;
GType steadyflow_core_idownload_file_get_type (void) G_GNUC_CONST;
GType steadyflow_core_idownload_service_get_type (void) G_GNUC_CONST;
SteadyflowCoreIDownloadService* steadyflow_services_get_download (void);
GeeList* steadyflow_core_idownload_service_get_files (SteadyflowCoreIDownloadService* self);
static void steadyflow_file_list_controller_connect_file_signals (SteadyflowFileListController* self, SteadyflowCoreIDownloadFile* file);
static void steadyflow_file_list_controller_update_model (SteadyflowFileListController* self);
static void __lambda25_ (SteadyflowFileListController* self, SteadyflowCoreIDownloadFile* file);
static void ___lambda25__steadyflow_core_idownload_service_file_added (SteadyflowCoreIDownloadService* _sender, SteadyflowCoreIDownloadFile* file, gpointer self);
static void __lambda26_ (SteadyflowFileListController* self, SteadyflowCoreIDownloadFile* file);
static void ___lambda26__steadyflow_core_idownload_service_file_removed (SteadyflowCoreIDownloadService* _sender, SteadyflowCoreIDownloadFile* file, gpointer self);
static void __lambda27_ (SteadyflowFileListController* self);
static void ___lambda27__gtk_tree_selection_changed (GtkTreeSelection* _sender, gpointer self);
static SteadyflowCoreIDownloadFile* steadyflow_file_list_controller_file_from_iter (SteadyflowFileListController* self, GtkTreeIter* iter);
void steadyflow_ui_download_cell_renderer_set_file (SteadyflowUIDownloadCellRenderer* self, SteadyflowCoreIDownloadFile* value);
static void __lambda23_ (SteadyflowFileListController* self, SteadyflowCoreIDownloadFileStatus status);
static void ___lambda23__steadyflow_core_idownload_file_status_changed (SteadyflowCoreIDownloadFile* _sender, SteadyflowCoreIDownloadFileStatus old_status, gpointer self);
static void __lambda24_ (SteadyflowFileListController* self, gint64 size);
static void steadyflow_file_list_controller_on_progress_notify (SteadyflowFileListController* self);
static void ___lambda24__steadyflow_core_idownload_file_download_progressed (SteadyflowCoreIDownloadFile* _sender, gint64 old_size, gpointer self);
static void steadyflow_file_list_controller_set_mount_operation (SteadyflowFileListController* self, GMountOperation** mount_op);
static void _steadyflow_file_list_controller_set_mount_operation_steadyflow_core_idownload_file_get_mount_operation (SteadyflowCoreIDownloadFile* _sender, GMountOperation** mount_op, gpointer self);
const gchar* steadyflow_core_idownload_file_get_local_basename (SteadyflowCoreIDownloadFile* self);
gint steadyflow_file_list_controller_get_selection_count (SteadyflowFileListController* self);
SteadyflowCoreIDownloadFile* steadyflow_file_list_controller_get_selected_file (SteadyflowFileListController* self);
GeeList* steadyflow_file_list_controller_get_selected_files (SteadyflowFileListController* self);
static void _gtk_tree_path_free0_ (gpointer var);
static void _g_list_free__gtk_tree_path_free0_ (GList* self);
SteadyflowCoreIDownloadFile* steadyflow_file_list_controller_get_file_at_widget_pos (SteadyflowFileListController* self, gint x, gint y);
void steadyflow_file_list_controller_set_filter (SteadyflowFileListController* self, const gchar* filter);
GType steadyflow_ui_gtk_builder_dialog_get_type (void) G_GNUC_CONST;
GType steadyflow_add_file_dialog_get_type (void) G_GNUC_CONST;
void steadyflow_file_list_controller_on_file_add_request (SteadyflowFileListController* self, SteadyflowAddFileDialog* dlg);
SteadyflowCoreIDownloadFileFinishAction steadyflow_add_file_dialog_get_finish_action (SteadyflowAddFileDialog* self);
gchar* steadyflow_add_file_dialog_get_finish_command (SteadyflowAddFileDialog* self);
#define STEADYFLOW_UI_UI_UTIL_MESSAGE_FORMAT "<span weight='bold' size='larger'>%s</span>\n\n%s\n"
gchar* steadyflow_add_file_dialog_get_save_path (SteadyflowAddFileDialog* self);
gchar* steadyflow_add_file_dialog_get_url (SteadyflowAddFileDialog* self);
const gchar* steadyflow_core_idownload_file_get_url (SteadyflowCoreIDownloadFile* self);
SteadyflowCoreIDownloadFile* steadyflow_core_idownload_service_add_file (SteadyflowCoreIDownloadService* self, const gchar* url, const gchar* local_name, SteadyflowCoreIDownloadFileFinishAction finish_action, const gchar* finish_command, GError** error);
static void steadyflow_file_list_controller_finalize (GObject* obj);


static gpointer _g_object_ref0 (gpointer self) {
	return self ? g_object_ref (self) : NULL;
}


static void _steadyflow_file_list_controller_set_cell_data_gtk_cell_layout_data_func (GtkCellLayout* cell_layout, GtkCellRenderer* cell, GtkTreeModel* tree_model, GtkTreeIter* iter, gpointer self) {
	steadyflow_file_list_controller_set_cell_data (self, cell_layout, cell, tree_model, iter);
}


static void __lambda25_ (SteadyflowFileListController* self, SteadyflowCoreIDownloadFile* file) {
	SteadyflowCoreIDownloadFile* _tmp0_;
	g_return_if_fail (file != NULL);
	_tmp0_ = file;
	steadyflow_file_list_controller_connect_file_signals (self, _tmp0_);
	steadyflow_file_list_controller_update_model (self);
}


static void ___lambda25__steadyflow_core_idownload_service_file_added (SteadyflowCoreIDownloadService* _sender, SteadyflowCoreIDownloadFile* file, gpointer self) {
	__lambda25_ (self, file);
}


static void __lambda26_ (SteadyflowFileListController* self, SteadyflowCoreIDownloadFile* file) {
	g_return_if_fail (file != NULL);
	steadyflow_file_list_controller_update_model (self);
}


static void ___lambda26__steadyflow_core_idownload_service_file_removed (SteadyflowCoreIDownloadService* _sender, SteadyflowCoreIDownloadFile* file, gpointer self) {
	__lambda26_ (self, file);
}


static void __lambda27_ (SteadyflowFileListController* self) {
	g_signal_emit_by_name (self, "selection-changed");
}


static void ___lambda27__gtk_tree_selection_changed (GtkTreeSelection* _sender, gpointer self) {
	__lambda27_ (self);
}


SteadyflowFileListController* steadyflow_file_list_controller_construct (GType object_type, GtkTreeView* tree) {
	SteadyflowFileListController * self = NULL;
	GtkTreeView* _tmp0_;
	GtkTreeView* _tmp1_;
	GtkTreeView* _tmp2_;
	GtkTreeSelection* _tmp3_ = NULL;
	GTimer* _tmp4_;
	GTimer* _tmp5_;
	GtkTreeViewColumn* _tmp6_;
	GtkTreeViewColumn* _tmp7_;
	GtkTreeViewColumn* column;
	GtkTreeViewColumn* _tmp8_;
	GtkTreeViewColumn* _tmp9_;
	SteadyflowUIDownloadCellRenderer* _tmp10_;
	GtkCellRenderer* _tmp11_;
	GtkCellRenderer* renderer;
	GtkTreeViewColumn* _tmp12_;
	GtkCellRenderer* _tmp13_;
	GtkTreeViewColumn* _tmp14_;
	GtkCellRenderer* _tmp15_;
	GType* _tmp16_ = NULL;
	GType* _tmp17_;
	gint _tmp17__length1;
	GtkListStore* _tmp18_;
	GtkTreeView* _tmp19_;
	GtkListStore* _tmp20_;
	GtkTreeView* _tmp21_;
	GtkTreeViewColumn* _tmp22_;
	SteadyflowCoreIDownloadService* _tmp37_;
	SteadyflowCoreIDownloadService* _tmp38_;
	SteadyflowCoreIDownloadService* _tmp39_;
	SteadyflowCoreIDownloadService* _tmp40_;
	GtkTreeView* _tmp41_;
	GtkTreeSelection* _tmp42_ = NULL;
	g_return_val_if_fail (tree != NULL, NULL);
	self = (SteadyflowFileListController*) g_object_new (object_type, NULL);
	_tmp0_ = tree;
	_tmp1_ = _g_object_ref0 (_tmp0_);
	_g_object_unref0 (self->priv->tree);
	self->priv->tree = _tmp1_;
	_tmp2_ = tree;
	_tmp3_ = gtk_tree_view_get_selection (_tmp2_);
	gtk_tree_selection_set_mode (_tmp3_, GTK_SELECTION_MULTIPLE);
	_tmp4_ = g_timer_new ();
	_g_timer_destroy0 (self->priv->redraw_timer);
	self->priv->redraw_timer = _tmp4_;
	_tmp5_ = self->priv->redraw_timer;
	g_timer_start (_tmp5_);
	_tmp6_ = gtk_tree_view_column_new ();
	_tmp7_ = g_object_ref_sink (_tmp6_);
	column = _tmp7_;
	_tmp8_ = column;
	gtk_tree_view_column_set_expand (_tmp8_, TRUE);
	_tmp9_ = column;
	gtk_tree_view_column_set_clickable (_tmp9_, FALSE);
	_tmp10_ = steadyflow_ui_download_cell_renderer_new ();
	_tmp11_ = (GtkCellRenderer*) g_object_ref_sink (_tmp10_);
	renderer = _tmp11_;
	_tmp12_ = column;
	_tmp13_ = renderer;
	gtk_cell_layout_pack_start ((GtkCellLayout*) _tmp12_, _tmp13_, TRUE);
	_tmp14_ = column;
	_tmp15_ = renderer;
	gtk_cell_layout_set_cell_data_func ((GtkCellLayout*) _tmp14_, _tmp15_, _steadyflow_file_list_controller_set_cell_data_gtk_cell_layout_data_func, g_object_ref (self), g_object_unref);
	_tmp16_ = g_new0 (GType, 1);
	_tmp16_[0] = STEADYFLOW_CORE_TYPE_IDOWNLOAD_FILE;
	_tmp17_ = _tmp16_;
	_tmp17__length1 = 1;
	_tmp18_ = gtk_list_store_newv (1, _tmp17_);
	_g_object_unref0 (self->priv->model);
	self->priv->model = _tmp18_;
	_tmp17_ = (g_free (_tmp17_), NULL);
	_tmp19_ = tree;
	_tmp20_ = self->priv->model;
	gtk_tree_view_set_model (_tmp19_, (GtkTreeModel*) _tmp20_);
	_tmp21_ = tree;
	_tmp22_ = column;
	gtk_tree_view_append_column (_tmp21_, _tmp22_);
	{
		SteadyflowCoreIDownloadService* _tmp23_;
		SteadyflowCoreIDownloadService* _tmp24_;
		GeeList* _tmp25_;
		GeeList* _tmp26_;
		GeeList* _file_list;
		GeeList* _tmp27_;
		gint _tmp28_;
		gint _tmp29_;
		gint _file_size;
		gint _file_index;
		_tmp23_ = steadyflow_services_get_download ();
		_tmp24_ = _tmp23_;
		_tmp25_ = steadyflow_core_idownload_service_get_files (_tmp24_);
		_tmp26_ = _tmp25_;
		_file_list = _tmp26_;
		_tmp27_ = _file_list;
		_tmp28_ = gee_collection_get_size ((GeeCollection*) _tmp27_);
		_tmp29_ = _tmp28_;
		_file_size = _tmp29_;
		_file_index = -1;
		while (TRUE) {
			gint _tmp30_;
			gint _tmp31_;
			gint _tmp32_;
			GeeList* _tmp33_;
			gint _tmp34_;
			gpointer _tmp35_ = NULL;
			SteadyflowCoreIDownloadFile* file;
			SteadyflowCoreIDownloadFile* _tmp36_;
			_tmp30_ = _file_index;
			_file_index = _tmp30_ + 1;
			_tmp31_ = _file_index;
			_tmp32_ = _file_size;
			if (!(_tmp31_ < _tmp32_)) {
				break;
			}
			_tmp33_ = _file_list;
			_tmp34_ = _file_index;
			_tmp35_ = gee_list_get (_tmp33_, _tmp34_);
			file = (SteadyflowCoreIDownloadFile*) _tmp35_;
			_tmp36_ = file;
			steadyflow_file_list_controller_connect_file_signals (self, _tmp36_);
			_g_object_unref0 (file);
		}
		_g_object_unref0 (_file_list);
	}
	steadyflow_file_list_controller_update_model (self);
	_tmp37_ = steadyflow_services_get_download ();
	_tmp38_ = _tmp37_;
	g_signal_connect_object (_tmp38_, "file-added", (GCallback) ___lambda25__steadyflow_core_idownload_service_file_added, self, 0);
	_tmp39_ = steadyflow_services_get_download ();
	_tmp40_ = _tmp39_;
	g_signal_connect_object (_tmp40_, "file-removed", (GCallback) ___lambda26__steadyflow_core_idownload_service_file_removed, self, 0);
	_tmp41_ = tree;
	_tmp42_ = gtk_tree_view_get_selection (_tmp41_);
	g_signal_connect_object (_tmp42_, "changed", (GCallback) ___lambda27__gtk_tree_selection_changed, self, 0);
	_g_object_unref0 (renderer);
	_g_object_unref0 (column);
	return self;
}


SteadyflowFileListController* steadyflow_file_list_controller_new (GtkTreeView* tree) {
	return steadyflow_file_list_controller_construct (STEADYFLOW_TYPE_FILE_LIST_CONTROLLER, tree);
}


static SteadyflowCoreIDownloadFile* steadyflow_file_list_controller_file_from_iter (SteadyflowFileListController* self, GtkTreeIter* iter) {
	SteadyflowCoreIDownloadFile* result = NULL;
	GValue value = {0};
	GtkListStore* _tmp0_;
	GtkTreeIter _tmp1_;
	GValue _tmp2_ = {0};
	GObject* _tmp3_ = NULL;
	SteadyflowCoreIDownloadFile* _tmp4_;
	g_return_val_if_fail (self != NULL, NULL);
	g_return_val_if_fail (iter != NULL, NULL);
	_tmp0_ = self->priv->model;
	_tmp1_ = *iter;
	gtk_tree_model_get_value ((GtkTreeModel*) _tmp0_, &_tmp1_, 0, &_tmp2_);
	G_IS_VALUE (&value) ? (g_value_unset (&value), NULL) : NULL;
	value = _tmp2_;
	_tmp3_ = g_value_get_object (&value);
	_tmp4_ = _g_object_ref0 (STEADYFLOW_CORE_IDOWNLOAD_FILE (_tmp3_));
	result = _tmp4_;
	G_IS_VALUE (&value) ? (g_value_unset (&value), NULL) : NULL;
	return result;
}


static void steadyflow_file_list_controller_set_cell_data (SteadyflowFileListController* self, GtkCellLayout* cell_layout, GtkCellRenderer* renderer, GtkTreeModel* model, GtkTreeIter* iter) {
	GtkCellRenderer* _tmp0_;
	GtkTreeIter _tmp1_;
	SteadyflowCoreIDownloadFile* _tmp2_ = NULL;
	SteadyflowCoreIDownloadFile* _tmp3_;
	g_return_if_fail (self != NULL);
	g_return_if_fail (cell_layout != NULL);
	g_return_if_fail (renderer != NULL);
	g_return_if_fail (model != NULL);
	g_return_if_fail (iter != NULL);
	_tmp0_ = renderer;
	_tmp1_ = *iter;
	_tmp2_ = steadyflow_file_list_controller_file_from_iter (self, &_tmp1_);
	_tmp3_ = _tmp2_;
	steadyflow_ui_download_cell_renderer_set_file (STEADYFLOW_UI_IS_DOWNLOAD_CELL_RENDERER (_tmp0_) ? ((SteadyflowUIDownloadCellRenderer*) _tmp0_) : NULL, _tmp3_);
	_g_object_unref0 (_tmp3_);
}


static void __lambda23_ (SteadyflowFileListController* self, SteadyflowCoreIDownloadFileStatus status) {
	GtkTreeView* _tmp0_;
	g_signal_emit_by_name (self, "selection-changed");
	g_signal_emit_by_name (self, "filelist-changed");
	_tmp0_ = self->priv->tree;
	gtk_widget_queue_draw ((GtkWidget*) _tmp0_);
}


static void ___lambda23__steadyflow_core_idownload_file_status_changed (SteadyflowCoreIDownloadFile* _sender, SteadyflowCoreIDownloadFileStatus old_status, gpointer self) {
	__lambda23_ (self, old_status);
}


static void __lambda24_ (SteadyflowFileListController* self, gint64 size) {
	steadyflow_file_list_controller_on_progress_notify (self);
}


static void ___lambda24__steadyflow_core_idownload_file_download_progressed (SteadyflowCoreIDownloadFile* _sender, gint64 old_size, gpointer self) {
	__lambda24_ (self, old_size);
}


static void _steadyflow_file_list_controller_set_mount_operation_steadyflow_core_idownload_file_get_mount_operation (SteadyflowCoreIDownloadFile* _sender, GMountOperation** mount_op, gpointer self) {
	steadyflow_file_list_controller_set_mount_operation (self, mount_op);
}


static void steadyflow_file_list_controller_connect_file_signals (SteadyflowFileListController* self, SteadyflowCoreIDownloadFile* file) {
	SteadyflowCoreIDownloadFile* _tmp0_;
	SteadyflowCoreIDownloadFile* _tmp1_;
	SteadyflowCoreIDownloadFile* _tmp2_;
	g_return_if_fail (self != NULL);
	g_return_if_fail (file != NULL);
	_tmp0_ = file;
	g_signal_connect_object (_tmp0_, "status-changed", (GCallback) ___lambda23__steadyflow_core_idownload_file_status_changed, self, 0);
	_tmp1_ = file;
	g_signal_connect_object (_tmp1_, "download-progressed", (GCallback) ___lambda24__steadyflow_core_idownload_file_download_progressed, self, 0);
	_tmp2_ = file;
	g_signal_connect_object (_tmp2_, "get-mount-operation", (GCallback) _steadyflow_file_list_controller_set_mount_operation_steadyflow_core_idownload_file_get_mount_operation, self, 0);
}


static void steadyflow_file_list_controller_set_mount_operation (SteadyflowFileListController* self, GMountOperation** mount_op) {
	GMountOperation* _vala_mount_op = NULL;
	GtkMountOperation* _tmp0_;
	g_return_if_fail (self != NULL);
	_tmp0_ = (GtkMountOperation*) gtk_mount_operation_new (NULL);
	_g_object_unref0 (_vala_mount_op);
	_vala_mount_op = (GMountOperation*) _tmp0_;
	if (mount_op) {
		*mount_op = _vala_mount_op;
	} else {
		_g_object_unref0 (_vala_mount_op);
	}
}


static gboolean string_contains (const gchar* self, const gchar* needle) {
	gboolean result = FALSE;
	const gchar* _tmp0_;
	gchar* _tmp1_ = NULL;
	g_return_val_if_fail (self != NULL, FALSE);
	g_return_val_if_fail (needle != NULL, FALSE);
	_tmp0_ = needle;
	_tmp1_ = strstr ((gchar*) self, (gchar*) _tmp0_);
	result = _tmp1_ != NULL;
	return result;
}


static void steadyflow_file_list_controller_update_model (SteadyflowFileListController* self) {
	GtkListStore* _tmp0_;
	g_return_if_fail (self != NULL);
	_tmp0_ = self->priv->model;
	gtk_list_store_clear (_tmp0_);
	{
		SteadyflowCoreIDownloadService* _tmp1_;
		SteadyflowCoreIDownloadService* _tmp2_;
		GeeList* _tmp3_;
		GeeList* _tmp4_;
		GeeList* _file_list;
		GeeList* _tmp5_;
		gint _tmp6_;
		gint _tmp7_;
		gint _file_size;
		gint _file_index;
		_tmp1_ = steadyflow_services_get_download ();
		_tmp2_ = _tmp1_;
		_tmp3_ = steadyflow_core_idownload_service_get_files (_tmp2_);
		_tmp4_ = _tmp3_;
		_file_list = _tmp4_;
		_tmp5_ = _file_list;
		_tmp6_ = gee_collection_get_size ((GeeCollection*) _tmp5_);
		_tmp7_ = _tmp6_;
		_file_size = _tmp7_;
		_file_index = -1;
		while (TRUE) {
			gint _tmp8_;
			gint _tmp9_;
			gint _tmp10_;
			GeeList* _tmp11_;
			gint _tmp12_;
			gpointer _tmp13_ = NULL;
			SteadyflowCoreIDownloadFile* file;
			SteadyflowCoreIDownloadFile* _tmp14_;
			const gchar* _tmp15_;
			const gchar* _tmp16_;
			gchar* _tmp17_ = NULL;
			gchar* _tmp18_;
			const gchar* _tmp19_;
			gboolean _tmp20_ = FALSE;
			gboolean _tmp21_;
			GtkTreeIter iter = {0};
			GtkListStore* _tmp22_;
			GtkTreeIter _tmp23_ = {0};
			GtkListStore* _tmp24_;
			GtkTreeIter _tmp25_;
			SteadyflowCoreIDownloadFile* _tmp26_;
			_tmp8_ = _file_index;
			_file_index = _tmp8_ + 1;
			_tmp9_ = _file_index;
			_tmp10_ = _file_size;
			if (!(_tmp9_ < _tmp10_)) {
				break;
			}
			_tmp11_ = _file_list;
			_tmp12_ = _file_index;
			_tmp13_ = gee_list_get (_tmp11_, _tmp12_);
			file = (SteadyflowCoreIDownloadFile*) _tmp13_;
			_tmp14_ = file;
			_tmp15_ = steadyflow_core_idownload_file_get_local_basename (_tmp14_);
			_tmp16_ = _tmp15_;
			_tmp17_ = g_utf8_casefold (_tmp16_, (gssize) (-1));
			_tmp18_ = _tmp17_;
			_tmp19_ = self->priv->filter;
			_tmp20_ = string_contains (_tmp18_, _tmp19_);
			_tmp21_ = !_tmp20_;
			_g_free0 (_tmp18_);
			if (_tmp21_) {
				_g_object_unref0 (file);
				continue;
			}
			_tmp22_ = self->priv->model;
			gtk_list_store_prepend (_tmp22_, &_tmp23_);
			iter = _tmp23_;
			_tmp24_ = self->priv->model;
			_tmp25_ = iter;
			_tmp26_ = file;
			gtk_list_store_set (_tmp24_, &_tmp25_, 0, _tmp26_, -1, -1);
			_g_object_unref0 (file);
		}
		_g_object_unref0 (_file_list);
	}
	g_signal_emit_by_name (self, "filelist-changed");
}


static void steadyflow_file_list_controller_on_progress_notify (SteadyflowFileListController* self) {
	GtkTreeView* _tmp0_;
	GtkWidget* _tmp1_ = NULL;
	gboolean _tmp2_;
	gboolean _tmp3_;
	GTimer* _tmp4_;
	gdouble _tmp5_ = 0.0;
	g_return_if_fail (self != NULL);
	_tmp0_ = self->priv->tree;
	_tmp1_ = gtk_widget_get_toplevel ((GtkWidget*) _tmp0_);
	_tmp2_ = gtk_widget_get_visible (_tmp1_);
	_tmp3_ = _tmp2_;
	if (!_tmp3_) {
		return;
	}
	_tmp4_ = self->priv->redraw_timer;
	_tmp5_ = g_timer_elapsed (_tmp4_, NULL);
	if (_tmp5_ >= STEADYFLOW_FILE_LIST_CONTROLLER_REDRAW_SEC) {
		GTimer* _tmp6_;
		GtkTreeView* _tmp7_;
		_tmp6_ = self->priv->redraw_timer;
		g_timer_start (_tmp6_);
		_tmp7_ = self->priv->tree;
		gtk_widget_queue_draw ((GtkWidget*) _tmp7_);
	}
}


gint steadyflow_file_list_controller_get_selection_count (SteadyflowFileListController* self) {
	gint result = 0;
	GtkTreeView* _tmp0_;
	GtkTreeSelection* _tmp1_ = NULL;
	gint _tmp2_ = 0;
	g_return_val_if_fail (self != NULL, 0);
	_tmp0_ = self->priv->tree;
	_tmp1_ = gtk_tree_view_get_selection (_tmp0_);
	_tmp2_ = gtk_tree_selection_count_selected_rows (_tmp1_);
	result = _tmp2_;
	return result;
}


SteadyflowCoreIDownloadFile* steadyflow_file_list_controller_get_selected_file (SteadyflowFileListController* self) {
	SteadyflowCoreIDownloadFile* result = NULL;
	gint _tmp0_ = 0;
	GtkTreePath* path = NULL;
	GtkTreeIter iter = {0};
	GtkTreeView* _tmp1_;
	GtkTreePath* _tmp2_ = NULL;
	GtkTreePath* _tmp3_;
	GtkListStore* _tmp4_;
	GtkTreePath* _tmp5_;
	GtkTreeIter _tmp6_ = {0};
	gboolean _tmp7_ = FALSE;
	g_return_val_if_fail (self != NULL, NULL);
	_tmp0_ = steadyflow_file_list_controller_get_selection_count (self);
	if (_tmp0_ != 1) {
		result = NULL;
		return result;
	}
	_tmp1_ = self->priv->tree;
	gtk_tree_view_get_cursor (_tmp1_, &_tmp2_, NULL);
	_gtk_tree_path_free0 (path);
	path = _tmp2_;
	_tmp3_ = path;
	if (_tmp3_ == NULL) {
		result = NULL;
		_gtk_tree_path_free0 (path);
		return result;
	}
	_tmp4_ = self->priv->model;
	_tmp5_ = path;
	_tmp7_ = gtk_tree_model_get_iter ((GtkTreeModel*) _tmp4_, &_tmp6_, _tmp5_);
	iter = _tmp6_;
	if (_tmp7_) {
		GtkTreeIter _tmp8_;
		SteadyflowCoreIDownloadFile* _tmp9_ = NULL;
		_tmp8_ = iter;
		_tmp9_ = steadyflow_file_list_controller_file_from_iter (self, &_tmp8_);
		result = _tmp9_;
		_gtk_tree_path_free0 (path);
		return result;
	} else {
		result = NULL;
		_gtk_tree_path_free0 (path);
		return result;
	}
	_gtk_tree_path_free0 (path);
}


static gpointer _gtk_tree_path_copy0 (gpointer self) {
	return self ? gtk_tree_path_copy (self) : NULL;
}


static void _gtk_tree_path_free0_ (gpointer var) {
	(var == NULL) ? NULL : (var = (gtk_tree_path_free (var), NULL));
}


static void _g_list_free__gtk_tree_path_free0_ (GList* self) {
	g_list_foreach (self, (GFunc) _gtk_tree_path_free0_, NULL);
	g_list_free (self);
}


GeeList* steadyflow_file_list_controller_get_selected_files (SteadyflowFileListController* self) {
	GeeList* result = NULL;
	GeeArrayList* _tmp0_;
	GeeArrayList* list;
	GtkTreeView* _tmp1_;
	GtkTreeSelection* _tmp2_ = NULL;
	GList* _tmp3_ = NULL;
	g_return_val_if_fail (self != NULL, NULL);
	_tmp0_ = gee_array_list_new (STEADYFLOW_CORE_TYPE_IDOWNLOAD_FILE, (GBoxedCopyFunc) g_object_ref, g_object_unref, NULL);
	list = _tmp0_;
	_tmp1_ = self->priv->tree;
	_tmp2_ = gtk_tree_view_get_selection (_tmp1_);
	_tmp3_ = gtk_tree_selection_get_selected_rows (_tmp2_, NULL);
	{
		GList* path_collection = NULL;
		GList* path_it = NULL;
		path_collection = _tmp3_;
		for (path_it = path_collection; path_it != NULL; path_it = path_it->next) {
			GtkTreePath* _tmp4_;
			GtkTreePath* path = NULL;
			_tmp4_ = _gtk_tree_path_copy0 ((GtkTreePath*) path_it->data);
			path = _tmp4_;
			{
				GtkTreeIter iter = {0};
				GtkListStore* _tmp5_;
				GtkTreePath* _tmp6_;
				GtkTreeIter _tmp7_ = {0};
				gboolean _tmp8_ = FALSE;
				_tmp5_ = self->priv->model;
				_tmp6_ = path;
				_tmp8_ = gtk_tree_model_get_iter ((GtkTreeModel*) _tmp5_, &_tmp7_, _tmp6_);
				iter = _tmp7_;
				if (_tmp8_) {
					GeeArrayList* _tmp9_;
					GtkTreeIter _tmp10_;
					SteadyflowCoreIDownloadFile* _tmp11_ = NULL;
					SteadyflowCoreIDownloadFile* _tmp12_;
					_tmp9_ = list;
					_tmp10_ = iter;
					_tmp11_ = steadyflow_file_list_controller_file_from_iter (self, &_tmp10_);
					_tmp12_ = _tmp11_;
					gee_abstract_collection_add ((GeeAbstractCollection*) _tmp9_, _tmp12_);
					_g_object_unref0 (_tmp12_);
				}
				_gtk_tree_path_free0 (path);
			}
		}
		__g_list_free__gtk_tree_path_free0_0 (path_collection);
	}
	result = (GeeList*) list;
	return result;
}


SteadyflowCoreIDownloadFile* steadyflow_file_list_controller_get_file_at_widget_pos (SteadyflowFileListController* self, gint x, gint y) {
	SteadyflowCoreIDownloadFile* result = NULL;
	gint bx = 0;
	gint by = 0;
	GtkTreeView* _tmp0_;
	gint _tmp1_;
	gint _tmp2_;
	gint _tmp3_ = 0;
	gint _tmp4_ = 0;
	GtkTreePath* path = NULL;
	GtkTreeIter iter = {0};
	GtkTreeView* _tmp5_;
	gint _tmp6_;
	gint _tmp7_;
	GtkTreePath* _tmp8_ = NULL;
	gboolean _tmp9_ = FALSE;
	g_return_val_if_fail (self != NULL, NULL);
	_tmp0_ = self->priv->tree;
	_tmp1_ = x;
	_tmp2_ = y;
	gtk_tree_view_convert_widget_to_bin_window_coords (_tmp0_, _tmp1_, _tmp2_, &_tmp3_, &_tmp4_);
	bx = _tmp3_;
	by = _tmp4_;
	_tmp5_ = self->priv->tree;
	_tmp6_ = bx;
	_tmp7_ = by;
	_tmp9_ = gtk_tree_view_get_path_at_pos (_tmp5_, _tmp6_, _tmp7_, &_tmp8_, NULL, NULL, NULL);
	_gtk_tree_path_free0 (path);
	path = _tmp8_;
	if (_tmp9_) {
		GtkListStore* _tmp10_;
		GtkTreePath* _tmp11_;
		GtkTreeIter _tmp12_ = {0};
		gboolean _tmp13_ = FALSE;
		_tmp10_ = self->priv->model;
		_tmp11_ = path;
		_tmp13_ = gtk_tree_model_get_iter ((GtkTreeModel*) _tmp10_, &_tmp12_, _tmp11_);
		iter = _tmp12_;
		if (_tmp13_) {
			GtkTreeIter _tmp14_;
			SteadyflowCoreIDownloadFile* _tmp15_ = NULL;
			_tmp14_ = iter;
			_tmp15_ = steadyflow_file_list_controller_file_from_iter (self, &_tmp14_);
			result = _tmp15_;
			_gtk_tree_path_free0 (path);
			return result;
		}
	}
	result = NULL;
	_gtk_tree_path_free0 (path);
	return result;
}


void steadyflow_file_list_controller_set_filter (SteadyflowFileListController* self, const gchar* filter) {
	const gchar* _tmp0_;
	gchar* _tmp1_ = NULL;
	g_return_if_fail (self != NULL);
	g_return_if_fail (filter != NULL);
	_tmp0_ = filter;
	_tmp1_ = g_utf8_casefold (_tmp0_, (gssize) (-1));
	_g_free0 (self->priv->filter);
	self->priv->filter = _tmp1_;
	steadyflow_file_list_controller_update_model (self);
}


void steadyflow_file_list_controller_on_file_add_request (SteadyflowFileListController* self, SteadyflowAddFileDialog* dlg) {
	gchar* save_to;
	gboolean _tmp0_ = FALSE;
	SteadyflowAddFileDialog* _tmp1_;
	SteadyflowCoreIDownloadFileFinishAction _tmp2_ = 0;
	gboolean _tmp6_;
	SteadyflowAddFileDialog* _tmp14_;
	gchar* _tmp15_ = NULL;
	const gchar* _tmp16_;
	SteadyflowAddFileDialog* _tmp24_;
	gchar* _tmp25_ = NULL;
	gchar* url;
	const gchar* _tmp50_;
	GFile* _tmp51_ = NULL;
	GFile* _tmp52_;
	gboolean _tmp53_ = FALSE;
	gboolean _tmp54_;
	SteadyflowAddFileDialog* _tmp67_;
	SteadyflowCoreIDownloadFileFinishAction _tmp68_ = 0;
	SteadyflowCoreIDownloadFileFinishAction finish_action;
	SteadyflowAddFileDialog* _tmp69_;
	gchar* _tmp70_ = NULL;
	gchar* finish_command;
	SteadyflowAddFileDialog* _tmp71_;
	GError * _inner_error_ = NULL;
	g_return_if_fail (self != NULL);
	g_return_if_fail (dlg != NULL);
	save_to = NULL;
	_tmp1_ = dlg;
	_tmp2_ = steadyflow_add_file_dialog_get_finish_action (_tmp1_);
	if (_tmp2_ == STEADYFLOW_CORE_IDOWNLOAD_FILE_FINISH_ACTION_RUN_COMMAND) {
		SteadyflowAddFileDialog* _tmp3_;
		gchar* _tmp4_ = NULL;
		gchar* _tmp5_;
		_tmp3_ = dlg;
		_tmp4_ = steadyflow_add_file_dialog_get_finish_command (_tmp3_);
		_tmp5_ = _tmp4_;
		_tmp0_ = _tmp5_ == NULL;
		_g_free0 (_tmp5_);
	} else {
		_tmp0_ = FALSE;
	}
	_tmp6_ = _tmp0_;
	if (_tmp6_) {
		SteadyflowAddFileDialog* _tmp7_;
		const gchar* _tmp8_ = NULL;
		const gchar* _tmp9_ = NULL;
		GtkMessageDialog* _tmp10_;
		GtkMessageDialog* _tmp11_;
		GtkMessageDialog* md;
		GtkMessageDialog* _tmp12_;
		GtkMessageDialog* _tmp13_;
		_tmp7_ = dlg;
		_tmp8_ = _ ("Please enter a command to run");
		_tmp9_ = _ ("You have specified that Steadyflow should run a command when the downl" \
"oad finishes, " "but have not entered a command to run. Please specify it.");
		_tmp10_ = (GtkMessageDialog*) gtk_message_dialog_new_with_markup ((GtkWindow*) _tmp7_, GTK_DIALOG_MODAL, GTK_MESSAGE_WARNING, GTK_BUTTONS_CLOSE, STEADYFLOW_UI_UI_UTIL_MESSAGE_FORMAT, _tmp8_, _tmp9_);
		_tmp11_ = g_object_ref_sink (_tmp10_);
		md = _tmp11_;
		_tmp12_ = md;
		gtk_dialog_run ((GtkDialog*) _tmp12_);
		_tmp13_ = md;
		gtk_widget_destroy ((GtkWidget*) _tmp13_);
		_g_object_unref0 (md);
		_g_free0 (save_to);
		return;
	}
	_tmp14_ = dlg;
	_tmp15_ = steadyflow_add_file_dialog_get_save_path (_tmp14_);
	_g_free0 (save_to);
	save_to = _tmp15_;
	_tmp16_ = save_to;
	if (_tmp16_ == NULL) {
		SteadyflowAddFileDialog* _tmp17_;
		const gchar* _tmp18_ = NULL;
		const gchar* _tmp19_ = NULL;
		GtkMessageDialog* _tmp20_;
		GtkMessageDialog* _tmp21_;
		GtkMessageDialog* md;
		GtkMessageDialog* _tmp22_;
		GtkMessageDialog* _tmp23_;
		_tmp17_ = dlg;
		_tmp18_ = _ ("Invalid file name");
		_tmp19_ = _ ("The file name you have entered is not valid. Please correct it.");
		_tmp20_ = (GtkMessageDialog*) gtk_message_dialog_new_with_markup ((GtkWindow*) _tmp17_, GTK_DIALOG_MODAL, GTK_MESSAGE_WARNING, GTK_BUTTONS_CLOSE, STEADYFLOW_UI_UI_UTIL_MESSAGE_FORMAT, _tmp18_, _tmp19_);
		_tmp21_ = g_object_ref_sink (_tmp20_);
		md = _tmp21_;
		_tmp22_ = md;
		gtk_dialog_run ((GtkDialog*) _tmp22_);
		_tmp23_ = md;
		gtk_widget_destroy ((GtkWidget*) _tmp23_);
		_g_object_unref0 (md);
		_g_free0 (save_to);
		return;
	}
	_tmp24_ = dlg;
	_tmp25_ = steadyflow_add_file_dialog_get_url (_tmp24_);
	url = _tmp25_;
	{
		SteadyflowCoreIDownloadService* _tmp26_;
		SteadyflowCoreIDownloadService* _tmp27_;
		GeeList* _tmp28_;
		GeeList* _tmp29_;
		GeeList* _file_list;
		GeeList* _tmp30_;
		gint _tmp31_;
		gint _tmp32_;
		gint _file_size;
		gint _file_index;
		_tmp26_ = steadyflow_services_get_download ();
		_tmp27_ = _tmp26_;
		_tmp28_ = steadyflow_core_idownload_service_get_files (_tmp27_);
		_tmp29_ = _tmp28_;
		_file_list = _tmp29_;
		_tmp30_ = _file_list;
		_tmp31_ = gee_collection_get_size ((GeeCollection*) _tmp30_);
		_tmp32_ = _tmp31_;
		_file_size = _tmp32_;
		_file_index = -1;
		while (TRUE) {
			gint _tmp33_;
			gint _tmp34_;
			gint _tmp35_;
			GeeList* _tmp36_;
			gint _tmp37_;
			gpointer _tmp38_ = NULL;
			SteadyflowCoreIDownloadFile* file;
			SteadyflowCoreIDownloadFile* _tmp39_;
			const gchar* _tmp40_;
			const gchar* _tmp41_;
			const gchar* _tmp42_;
			_tmp33_ = _file_index;
			_file_index = _tmp33_ + 1;
			_tmp34_ = _file_index;
			_tmp35_ = _file_size;
			if (!(_tmp34_ < _tmp35_)) {
				break;
			}
			_tmp36_ = _file_list;
			_tmp37_ = _file_index;
			_tmp38_ = gee_list_get (_tmp36_, _tmp37_);
			file = (SteadyflowCoreIDownloadFile*) _tmp38_;
			_tmp39_ = file;
			_tmp40_ = steadyflow_core_idownload_file_get_url (_tmp39_);
			_tmp41_ = _tmp40_;
			_tmp42_ = url;
			if (g_strcmp0 (_tmp41_, _tmp42_) == 0) {
				SteadyflowAddFileDialog* _tmp43_;
				const gchar* _tmp44_ = NULL;
				const gchar* _tmp45_ = NULL;
				GtkMessageDialog* _tmp46_;
				GtkMessageDialog* _tmp47_;
				GtkMessageDialog* md;
				GtkMessageDialog* _tmp48_;
				GtkMessageDialog* _tmp49_;
				_tmp43_ = dlg;
				_tmp44_ = _ ("File already in list");
				_tmp45_ = _ ("The address you are trying to add for download is already in the file " \
"list.");
				_tmp46_ = (GtkMessageDialog*) gtk_message_dialog_new_with_markup ((GtkWindow*) _tmp43_, GTK_DIALOG_MODAL, GTK_MESSAGE_ERROR, GTK_BUTTONS_OK, STEADYFLOW_UI_UI_UTIL_MESSAGE_FORMAT, _tmp44_, _tmp45_);
				_tmp47_ = g_object_ref_sink (_tmp46_);
				md = _tmp47_;
				_tmp48_ = md;
				gtk_dialog_run ((GtkDialog*) _tmp48_);
				_tmp49_ = md;
				gtk_widget_destroy ((GtkWidget*) _tmp49_);
				_g_object_unref0 (md);
				_g_object_unref0 (file);
				_g_object_unref0 (_file_list);
				_g_free0 (url);
				_g_free0 (save_to);
				return;
			}
			_g_object_unref0 (file);
		}
		_g_object_unref0 (_file_list);
	}
	_tmp50_ = save_to;
	_tmp51_ = g_file_new_for_path (_tmp50_);
	_tmp52_ = _tmp51_;
	_tmp53_ = g_file_query_exists (_tmp52_, NULL);
	_tmp54_ = _tmp53_;
	_g_object_unref0 (_tmp52_);
	if (_tmp54_) {
		SteadyflowAddFileDialog* _tmp55_;
		const gchar* _tmp56_ = NULL;
		const gchar* _tmp57_ = NULL;
		GtkMessageDialog* _tmp58_;
		GtkMessageDialog* _tmp59_;
		GtkMessageDialog* md;
		GtkMessageDialog* _tmp60_;
		GtkMessageDialog* _tmp61_;
		const gchar* _tmp62_ = NULL;
		GtkMessageDialog* _tmp63_;
		gint _tmp64_ = 0;
		gint response;
		GtkMessageDialog* _tmp65_;
		gint _tmp66_;
		_tmp55_ = dlg;
		_tmp56_ = _ ("File exists");
		_tmp57_ = _ ("The file you are trying to save the download to already exists. " "Are you sure you want to overwrite it?");
		_tmp58_ = (GtkMessageDialog*) gtk_message_dialog_new_with_markup ((GtkWindow*) _tmp55_, GTK_DIALOG_MODAL, GTK_MESSAGE_WARNING, GTK_BUTTONS_NONE, STEADYFLOW_UI_UI_UTIL_MESSAGE_FORMAT, _tmp56_, _tmp57_);
		_tmp59_ = g_object_ref_sink (_tmp58_);
		md = _tmp59_;
		_tmp60_ = md;
		gtk_dialog_add_button ((GtkDialog*) _tmp60_, GTK_STOCK_CANCEL, (gint) GTK_RESPONSE_CANCEL);
		_tmp61_ = md;
		_tmp62_ = _ ("Overwrite");
		gtk_dialog_add_button ((GtkDialog*) _tmp61_, _tmp62_, (gint) GTK_RESPONSE_OK);
		_tmp63_ = md;
		_tmp64_ = gtk_dialog_run ((GtkDialog*) _tmp63_);
		response = _tmp64_;
		_tmp65_ = md;
		gtk_widget_destroy ((GtkWidget*) _tmp65_);
		_tmp66_ = response;
		if (_tmp66_ != ((gint) GTK_RESPONSE_OK)) {
			_g_object_unref0 (md);
			_g_free0 (url);
			_g_free0 (save_to);
			return;
		}
		_g_object_unref0 (md);
	}
	_tmp67_ = dlg;
	_tmp68_ = steadyflow_add_file_dialog_get_finish_action (_tmp67_);
	finish_action = _tmp68_;
	_tmp69_ = dlg;
	_tmp70_ = steadyflow_add_file_dialog_get_finish_command (_tmp69_);
	finish_command = _tmp70_;
	_tmp71_ = dlg;
	gtk_widget_destroy ((GtkWidget*) _tmp71_);
	{
		SteadyflowCoreIDownloadService* _tmp72_;
		SteadyflowCoreIDownloadService* _tmp73_;
		const gchar* _tmp74_;
		const gchar* _tmp75_;
		SteadyflowCoreIDownloadFileFinishAction _tmp76_;
		const gchar* _tmp77_;
		SteadyflowCoreIDownloadFile* _tmp78_ = NULL;
		SteadyflowCoreIDownloadFile* _tmp79_;
		_tmp72_ = steadyflow_services_get_download ();
		_tmp73_ = _tmp72_;
		_tmp74_ = url;
		_tmp75_ = save_to;
		_tmp76_ = finish_action;
		_tmp77_ = finish_command;
		_tmp78_ = steadyflow_core_idownload_service_add_file (_tmp73_, _tmp74_, _tmp75_, _tmp76_, _tmp77_, &_inner_error_);
		_tmp79_ = _tmp78_;
		_g_object_unref0 (_tmp79_);
		if (_inner_error_ != NULL) {
			goto __catch17_g_error;
		}
	}
	goto __finally17;
	__catch17_g_error:
	{
		GError* e = NULL;
		const gchar* _tmp80_ = NULL;
		const gchar* _tmp81_ = NULL;
		gchar* _tmp82_;
		gchar* _tmp83_;
		GError* _tmp84_;
		const gchar* _tmp85_;
		gchar* _tmp86_;
		gchar* _tmp87_;
		GtkMessageDialog* _tmp88_;
		GtkMessageDialog* _tmp89_;
		GtkMessageDialog* _tmp90_;
		GtkMessageDialog* md;
		GtkMessageDialog* _tmp91_;
		GtkMessageDialog* _tmp92_;
		e = _inner_error_;
		_inner_error_ = NULL;
		_tmp80_ = _ ("Error adding download");
		_tmp81_ = _ ("An error has occurred while trying to start the download.");
		_tmp82_ = g_strconcat (_tmp81_, "\n\n", NULL);
		_tmp83_ = _tmp82_;
		_tmp84_ = e;
		_tmp85_ = _tmp84_->message;
		_tmp86_ = g_strconcat (_tmp83_, _tmp85_, NULL);
		_tmp87_ = _tmp86_;
		_tmp88_ = (GtkMessageDialog*) gtk_message_dialog_new_with_markup (NULL, 0, GTK_MESSAGE_ERROR, GTK_BUTTONS_CLOSE, STEADYFLOW_UI_UI_UTIL_MESSAGE_FORMAT, _tmp80_, _tmp87_);
		_tmp89_ = g_object_ref_sink (_tmp88_);
		_tmp90_ = _tmp89_;
		_g_free0 (_tmp87_);
		_g_free0 (_tmp83_);
		md = _tmp90_;
		_tmp91_ = md;
		gtk_dialog_run ((GtkDialog*) _tmp91_);
		_tmp92_ = md;
		gtk_widget_destroy ((GtkWidget*) _tmp92_);
		_g_object_unref0 (md);
		_g_error_free0 (e);
	}
	__finally17:
	if (_inner_error_ != NULL) {
		_g_free0 (finish_command);
		_g_free0 (url);
		_g_free0 (save_to);
		g_critical ("file %s: line %d: uncaught error: %s (%s, %d)", __FILE__, __LINE__, _inner_error_->message, g_quark_to_string (_inner_error_->domain), _inner_error_->code);
		g_clear_error (&_inner_error_);
		return;
	}
	_g_free0 (finish_command);
	_g_free0 (url);
	_g_free0 (save_to);
}


static void steadyflow_file_list_controller_class_init (SteadyflowFileListControllerClass * klass) {
	steadyflow_file_list_controller_parent_class = g_type_class_peek_parent (klass);
	g_type_class_add_private (klass, sizeof (SteadyflowFileListControllerPrivate));
	G_OBJECT_CLASS (klass)->finalize = steadyflow_file_list_controller_finalize;
	g_signal_new ("filelist_changed", STEADYFLOW_TYPE_FILE_LIST_CONTROLLER, G_SIGNAL_RUN_LAST, 0, NULL, NULL, g_cclosure_marshal_VOID__VOID, G_TYPE_NONE, 0);
	g_signal_new ("selection_changed", STEADYFLOW_TYPE_FILE_LIST_CONTROLLER, G_SIGNAL_RUN_LAST, 0, NULL, NULL, g_cclosure_marshal_VOID__VOID, G_TYPE_NONE, 0);
}


static void steadyflow_file_list_controller_instance_init (SteadyflowFileListController * self) {
	gchar* _tmp0_;
	self->priv = STEADYFLOW_FILE_LIST_CONTROLLER_GET_PRIVATE (self);
	_tmp0_ = g_strdup ("");
	self->priv->filter = _tmp0_;
}


static void steadyflow_file_list_controller_finalize (GObject* obj) {
	SteadyflowFileListController * self;
	self = STEADYFLOW_FILE_LIST_CONTROLLER (obj);
	_g_object_unref0 (self->priv->tree);
	_g_object_unref0 (self->priv->model);
	_g_free0 (self->priv->filter);
	_g_timer_destroy0 (self->priv->redraw_timer);
	G_OBJECT_CLASS (steadyflow_file_list_controller_parent_class)->finalize (obj);
}


GType steadyflow_file_list_controller_get_type (void) {
	static volatile gsize steadyflow_file_list_controller_type_id__volatile = 0;
	if (g_once_init_enter (&steadyflow_file_list_controller_type_id__volatile)) {
		static const GTypeInfo g_define_type_info = { sizeof (SteadyflowFileListControllerClass), (GBaseInitFunc) NULL, (GBaseFinalizeFunc) NULL, (GClassInitFunc) steadyflow_file_list_controller_class_init, (GClassFinalizeFunc) NULL, NULL, sizeof (SteadyflowFileListController), 0, (GInstanceInitFunc) steadyflow_file_list_controller_instance_init, NULL };
		GType steadyflow_file_list_controller_type_id;
		steadyflow_file_list_controller_type_id = g_type_register_static (G_TYPE_OBJECT, "SteadyflowFileListController", &g_define_type_info, 0);
		g_once_init_leave (&steadyflow_file_list_controller_type_id__volatile, steadyflow_file_list_controller_type_id);
	}
	return steadyflow_file_list_controller_type_id__volatile;
}



